#!/usr/bin/env python3
"""
ุณููุงุฑูู ุดุงูู ูุงุฎุชุจุงุฑ ูุธุงู ุงูุฅุดุนุงุฑุงุช - Comprehensive Notification System Scenario
"""

import requests
import sys
import json
from datetime import datetime
import time

def comprehensive_notification_scenario():
    """ุณููุงุฑูู ุดุงูู ูุงุฎุชุจุงุฑ ูุธุงู ุงูุฅุดุนุงุฑุงุช"""
    base_url = "https://1f2d6d1b-2bd0-43af-b264-1ed679832703.preview.emergentagent.com"
    api_url = f"{base_url}/api"
    
    print("๐ฏ ุณููุงุฑูู ุดุงูู ูุงุฎุชุจุงุฑ ูุธุงู ุงูุฅุดุนุงุฑุงุช")
    print("=" * 60)
    print()
    
    # 1. ุชุณุฌูู ุฏุฎูู ุงูุฃุฏูู
    print("1๏ธโฃ ุชุณุฌูู ุฏุฎูู ุงูุฃุฏูู...")
    admin_credentials = {"username": "admin", "password": "admin123"}
    
    try:
        response = requests.post(
            f"{api_url}/admin/login",
            json=admin_credentials,
            headers={'Content-Type': 'application/json'},
            timeout=10
        )
        
        if response.status_code != 200:
            print("โ ูุดู ูู ุชุณุฌูู ุฏุฎูู ุงูุฃุฏูู")
            return False
            
        admin_token = response.json().get('access_token')
        auth_headers = {"Authorization": f"Bearer {admin_token}"}
        print("โ ุชู ุชุณุฌูู ุฏุฎูู ุงูุฃุฏูู ุจูุฌุงุญ")
        print()
        
    except Exception as e:
        print(f"โ ุฎุทุฃ ูู ุชุณุฌูู ุงูุฏุฎูู: {str(e)}")
        return False
    
    # 2. ุฅูุดุงุก ูุดุชุฑููู ุฌุฏุฏ
    print("2๏ธโฃ ุฅูุดุงุก ูุดุชุฑููู ุฌุฏุฏ...")
    
    subscribers = [
        {
            "email": "student1@school.edu",
            "name": "ุฃุญูุฏ ูุญูุฏ ุนูู",
            "phone": "01234567890",
            "educational_stage": "ุงูุซุงูููุฉ ุงูุนุงูุฉ",
            "region": "ุงููุงูุฑุฉ",
            "notification_preferences": {
                "new_results": True,
                "system_updates": True,
                "educational_content": False,
                "emergency_notifications": True
            }
        },
        {
            "email": "student2@school.edu",
            "name": "ูุงุทูุฉ ุฃุญูุฏ ูุญููุฏ",
            "phone": "01098765432",
            "educational_stage": "ุงูุดูุงุฏุฉ ุงูุฅุนุฏุงุฏูุฉ",
            "region": "ุงูุฌูุฒุฉ",
            "notification_preferences": {
                "new_results": True,
                "system_updates": False,
                "educational_content": True,
                "emergency_notifications": True
            }
        },
        {
            "email": "student3@school.edu",
            "name": "ูุญูุฏ ุนูู ุญุณู",
            "phone": "01555666777",
            "educational_stage": "ุงูุฏุจูููุงุช ุงููููุฉ",
            "region": "ุงูุฅุณููุฏุฑูุฉ",
            "notification_preferences": {
                "new_results": True,
                "system_updates": True,
                "educational_content": True,
                "emergency_notifications": True
            }
        }
    ]
    
    created_subscribers = []
    
    for i, subscriber_data in enumerate(subscribers, 1):
        try:
            response = requests.post(
                f"{api_url}/subscribe",
                json=subscriber_data,
                headers={'Content-Type': 'application/json'},
                timeout=10
            )
            
            if response.status_code == 200:
                subscriber = response.json()
                created_subscribers.append(subscriber)
                print(f"โ ุชู ุฅูุดุงุก ุงููุดุชุฑู {i}: {subscriber['name']}")
            else:
                print(f"โ ูุดู ูู ุฅูุดุงุก ุงููุดุชุฑู {i}: {response.status_code}")
                
        except Exception as e:
            print(f"โ ุฎุทุฃ ูู ุฅูุดุงุก ุงููุดุชุฑู {i}: {str(e)}")
    
    print(f"๐ ุชู ุฅูุดุงุก {len(created_subscribers)} ูุดุชุฑู ุจูุฌุงุญ")
    print()
    
    # 3. ุนุฑุถ ุฅุญุตุงุฆูุงุช ุงููุดุชุฑููู
    print("3๏ธโฃ ุนุฑุถ ุฅุญุตุงุฆูุงุช ุงููุดุชุฑููู...")
    
    try:
        response = requests.get(
            f"{api_url}/admin/subscribers/stats",
            headers=auth_headers,
            timeout=10
        )
        
        if response.status_code == 200:
            stats = response.json()
            print("๐ ุฅุญุตุงุฆูุงุช ุงููุดุชุฑููู:")
            print(f"   โข ุฅุฌูุงูู ุงููุดุชุฑููู: {stats.get('total_subscribers', 0)}")
            print(f"   โข ุงููุดุทูู: {stats.get('active_subscribers', 0)}")
            print(f"   โข ุบูุฑ ุงููุดุทูู: {stats.get('inactive_subscribers', 0)}")
            
            if 'stage_distribution' in stats:
                print("   โข ุชูุฒูุน ุงููุฑุงุญู ุงูุชุนููููุฉ:")
                for stage, count in stats['stage_distribution'].items():
                    print(f"     - {stage}: {count}")
            
            if 'region_distribution' in stats:
                print("   โข ุชูุฒูุน ุงููุญุงูุธุงุช:")
                for region, count in stats['region_distribution'].items():
                    print(f"     - {region}: {count}")
        else:
            print(f"โ ูุดู ูู ุฌูุจ ุงูุฅุญุตุงุฆูุงุช: {response.status_code}")
            
    except Exception as e:
        print(f"โ ุฎุทุฃ ูู ุฌูุจ ุงูุฅุญุตุงุฆูุงุช: {str(e)}")
    
    print()
    
    # 4. ุฅูุดุงุก ุฅุดุนุงุฑุงุช ูุชููุนุฉ
    print("4๏ธโฃ ุฅูุดุงุก ุฅุดุนุงุฑุงุช ูุชููุนุฉ...")
    
    notifications = [
        {
            "title": "ุฅุนูุงู ูุชุงุฆุฌ ุงูุซุงูููุฉ ุงูุนุงูุฉ 2024",
            "content": """
# ุฅุนูุงู ูุชุงุฆุฌ ุงูุซุงูููุฉ ุงูุนุงูุฉ 2024

ุชู ุงูุฅุนูุงู ุนู ูุชุงุฆุฌ ุงูุซุงูููุฉ ุงูุนุงูุฉ ููุนุงู ุงูุฏุฑุงุณู 2024.

## ุชูุงุตูู ูููุฉ:
- ูููู ุงูุงุณุชุนูุงู ุนู ุงููุชุงุฆุฌ ูู ุฎูุงู ุงููููุน ุงูุฑุณูู
- ุชุฃูุฏ ูู ุฅุฏุฎุงู ุฑูู ุงูุฌููุณ ุจุดูู ุตุญูุญ
- ุงููุชุงุฆุฌ ูุชุงุญุฉ ุนูู ูุฏุงุฑ 24 ุณุงุนุฉ

## ููุงุณุชูุณุงุฑุงุช:
ุชูุงุตู ูุน ุงูุฅุฏุงุฑุฉ ุงููุฎุชุตุฉ ุฃู ุฒุฑ ุฃูุฑุจ ูุฏุฑุณุฉ.

**ูุชููู ูุฌููุน ุงูุทูุงุจ ุงูุชูููู ูุงููุฌุงุญ.**
            """,
            "summary": "ุชู ุงูุฅุนูุงู ุนู ูุชุงุฆุฌ ุงูุซุงูููุฉ ุงูุนุงูุฉ 2024. ูููู ุงูุงุณุชุนูุงู ุนู ุงููุชุงุฆุฌ ูู ุฎูุงู ุงููููุน ุงูุฑุณูู.",
            "notification_type": "new_results",
            "priority": "high",
            "target_audience": "stage",
            "target_stage": "ุงูุซุงูููุฉ ุงูุนุงูุฉ",
            "send_immediately": False
        },
        {
            "title": "ุชุญุฏูุซ ููู ูู ุงููุธุงู",
            "content": """
# ุชุญุฏูุซ ููู ูู ุงููุธุงู

ุชู ุชุทููุฑ ุงููุธุงู ุจูููุฒุงุช ุฌุฏูุฏุฉ ูุชุญุณูู ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู.

## ุงููููุฒุงุช ุงูุฌุฏูุฏุฉ:
- ูุธุงู ุฅุดุนุงุฑุงุช ูุชุทูุฑ
- ุจุญุซ ูุญุณู
- ูุงุฌูุฉ ูุณุชุฎุฏู ูุญุฏุซุฉ
- ุฃูุงู ูุนุฒุฒ

ุณูุชู ุชุทุจูู ุงูุชุญุฏูุซ ุฎูุงู ุงูุณุงุนุงุช ุงููุงุฏูุฉ.
            """,
            "summary": "ุชุญุฏูุซ ููู ูู ุงููุธุงู ูุน ูููุฒุงุช ุฌุฏูุฏุฉ ูุชุญุณูู ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู.",
            "notification_type": "system_update",
            "priority": "normal",
            "target_audience": "all",
            "send_immediately": True
        },
        {
            "title": "ูุญุชูู ุชุนูููู ุฌุฏูุฏ ูุชุงุญ",
            "content": """
# ูุญุชูู ุชุนูููู ุฌุฏูุฏ ูุชุงุญ

ุชู ุฅุถุงูุฉ ูุญุชูู ุชุนูููู ุฌุฏูุฏ ูุณุงุนุฏ ุงูุทูุงุจ ูู ุงูุชุญุถูุฑ ููุงูุชุญุงูุงุช.

## ุงููุญุชูู ุงูุฌุฏูุฏ ูุดูู:
- ุฃุฏูุฉ ุงููุฑุงุฌุนุฉ
- ูุตุงุฆุญ ููุงูุชุญุงูุงุช
- ุฃุณุฆูุฉ ุดุงุฆุนุฉ
- ููุงุฏ ุชุฏุฑูุจูุฉ

ูููููู ุงููุตูู ูููุญุชูู ูู ุฎูุงู ูุณู ุงูุฃุฏูุฉ ุงูุชุนููููุฉ.
            """,
            "summary": "ูุญุชูู ุชุนูููู ุฌุฏูุฏ ูุชุงุญ ููุทูุงุจ ูุน ุฃุฏูุฉ ุงููุฑุงุฌุนุฉ ููุตุงุฆุญ ุงูุงูุชุญุงูุงุช.",
            "notification_type": "educational_content",
            "priority": "low",
            "target_audience": "all",
            "send_immediately": False
        }
    ]
    
    created_notifications = []
    
    for i, notification_data in enumerate(notifications, 1):
        try:
            response = requests.post(
                f"{api_url}/admin/notifications",
                json=notification_data,
                headers={**auth_headers, 'Content-Type': 'application/json'},
                timeout=10
            )
            
            if response.status_code == 200:
                notification = response.json()
                created_notifications.append(notification)
                print(f"โ ุชู ุฅูุดุงุก ุงูุฅุดุนุงุฑ {i}: {notification['title'][:50]}...")
            else:
                print(f"โ ูุดู ูู ุฅูุดุงุก ุงูุฅุดุนุงุฑ {i}: {response.status_code}")
                
        except Exception as e:
            print(f"โ ุฎุทุฃ ูู ุฅูุดุงุก ุงูุฅุดุนุงุฑ {i}: {str(e)}")
    
    print(f"๐ ุชู ุฅูุดุงุก {len(created_notifications)} ุฅุดุนุงุฑ ุจูุฌุงุญ")
    print()
    
    # 5. ุฅุฑุณุงู ุงูุฅุดุนุงุฑุงุช
    print("5๏ธโฃ ุฅุฑุณุงู ุงูุฅุดุนุงุฑุงุช...")
    
    for i, notification in enumerate(created_notifications, 1):
        try:
            response = requests.post(
                f"{api_url}/admin/notifications/{notification['id']}/send",
                headers=auth_headers,
                timeout=15
            )
            
            if response.status_code == 200:
                result = response.json()
                print(f"โ ุชู ุฅุฑุณุงู ุงูุฅุดุนุงุฑ {i}: {result.get('message', 'ุชู ุงูุฅุฑุณุงู')}")
                print(f"   ๐ง ุนุฏุฏ ุงููุฑุณู ุฅูููู: {result.get('sent_count', 0)}")
                print(f"   โ ุงูุฃุฎุทุงุก: {result.get('failed_count', 0)}")
            else:
                print(f"โ ูุดู ูู ุฅุฑุณุงู ุงูุฅุดุนุงุฑ {i}: {response.status_code}")
                
        except Exception as e:
            print(f"โ ุฎุทุฃ ูู ุฅุฑุณุงู ุงูุฅุดุนุงุฑ {i}: {str(e)}")
        
        # ุงูุชุธุงุฑ ูุตูุฑ ุจูู ุงูุฅุฑุณุงูุงุช
        time.sleep(1)
    
    print()
    
    # 6. ุชุญุฏูุซ ุชูุถููุงุช ูุดุชุฑู
    print("6๏ธโฃ ุชุญุฏูุซ ุชูุถููุงุช ูุดุชุฑู...")
    
    if created_subscribers:
        subscriber_id = created_subscribers[0]['id']
        
        update_data = {
            "name": "ุฃุญูุฏ ูุญูุฏ ุนูู - ูุญุฏุซ",
            "phone": "01111222333",
            "educational_stage": "ุงูุฏุจูููุงุช ุงููููุฉ",
            "region": "ุงููุงูุฑุฉ",
            "notification_preferences": {
                "new_results": True,
                "system_updates": False,
                "educational_content": True,
                "emergency_notifications": True
            }
        }
        
        try:
            response = requests.put(
                f"{api_url}/admin/subscribers/{subscriber_id}",
                json=update_data,
                headers={**auth_headers, 'Content-Type': 'application/json'},
                timeout=10
            )
            
            if response.status_code == 200:
                updated_subscriber = response.json()
                print(f"โ ุชู ุชุญุฏูุซ ุงููุดุชุฑู: {updated_subscriber['name']}")
                print(f"   ๐ฑ ุงููุงุชู ุงูุฌุฏูุฏ: {updated_subscriber['phone']}")
                print(f"   ๐ ุงููุฑุญูุฉ ุงูุฌุฏูุฏุฉ: {updated_subscriber['educational_stage']}")
                
                # ุนุฑุถ ุงูุชูุถููุงุช ุงููุญุฏุซุฉ
                prefs = updated_subscriber['notification_preferences']
                active_prefs = [k for k, v in prefs.items() if v]
                print(f"   ๐ ุงูุชูุถููุงุช ุงููุดุทุฉ: {len(active_prefs)}/4")
            else:
                print(f"โ ูุดู ูู ุชุญุฏูุซ ุงููุดุชุฑู: {response.status_code}")
                
        except Exception as e:
            print(f"โ ุฎุทุฃ ูู ุชุญุฏูุซ ุงููุดุชุฑู: {str(e)}")
    
    print()
    
    # 7. ุนุฑุถ ุงูุฅุญุตุงุฆูุงุช ุงูููุงุฆูุฉ
    print("7๏ธโฃ ุงูุฅุญุตุงุฆูุงุช ุงูููุงุฆูุฉ...")
    
    try:
        # ุฅุญุตุงุฆูุงุช ุงููุดุชุฑููู
        subscribers_response = requests.get(
            f"{api_url}/admin/subscribers/stats",
            headers=auth_headers,
            timeout=10
        )
        
        # ูุงุฆูุฉ ุงูุฅุดุนุงุฑุงุช
        notifications_response = requests.get(
            f"{api_url}/admin/notifications",
            headers=auth_headers,
            timeout=10
        )
        
        if subscribers_response.status_code == 200 and notifications_response.status_code == 200:
            stats = subscribers_response.json()
            notifications_list = notifications_response.json()
            
            print("๐ ุงูุฅุญุตุงุฆูุงุช ุงูููุงุฆูุฉ:")
            print(f"   ๐ฅ ุฅุฌูุงูู ุงููุดุชุฑููู: {stats.get('total_subscribers', 0)}")
            print(f"   โ ุงููุดุชุฑููู ุงููุดุทูู: {stats.get('active_subscribers', 0)}")
            print(f"   ๐ง ุฅุฌูุงูู ุงูุฅุดุนุงุฑุงุช: {len(notifications_list)}")
            
            # ุฅุญุตุงุฆูุงุช ุญุงูุฉ ุงูุฅุดุนุงุฑุงุช
            status_counts = {}
            for notification in notifications_list:
                status = notification.get('status', 'unknown')
                status_counts[status] = status_counts.get(status, 0) + 1
            
            print("   ๐ ุญุงูุฉ ุงูุฅุดุนุงุฑุงุช:")
            for status, count in status_counts.items():
                print(f"     - {status}: {count}")
            
        else:
            print("โ ูุดู ูู ุฌูุจ ุงูุฅุญุตุงุฆูุงุช ุงูููุงุฆูุฉ")
            
    except Exception as e:
        print(f"โ ุฎุทุฃ ูู ุฌูุจ ุงูุฅุญุตุงุฆูุงุช ุงูููุงุฆูุฉ: {str(e)}")
    
    print()
    
    # 8. ุงุฎุชุจุงุฑ ุฅูุบุงุก ุงูุงุดุชุฑุงู
    print("8๏ธโฃ ุงุฎุชุจุงุฑ ุฅูุบุงุก ุงูุงุดุชุฑุงู...")
    
    if created_subscribers and len(created_subscribers) > 1:
        unsubscribe_token = created_subscribers[1]['unsubscribe_token']
        
        try:
            response = requests.post(
                f"{api_url}/unsubscribe/{unsubscribe_token}",
                timeout=10
            )
            
            if response.status_code == 200:
                result = response.json()
                print(f"โ ุชู ุฅูุบุงุก ุงูุงุดุชุฑุงู ุจูุฌุงุญ: {result.get('message', 'ุชู ุฅูุบุงุก ุงูุงุดุชุฑุงู')}")
            else:
                print(f"โ ูุดู ูู ุฅูุบุงุก ุงูุงุดุชุฑุงู: {response.status_code}")
                
        except Exception as e:
            print(f"โ ุฎุทุฃ ูู ุฅูุบุงุก ุงูุงุดุชุฑุงู: {str(e)}")
    
    print()
    print("=" * 60)
    print("๐ ุชู ุฅููุงู ุงูุณููุงุฑูู ุงูุดุงูู ูุงุฎุชุจุงุฑ ูุธุงู ุงูุฅุดุนุงุฑุงุช ุจูุฌุงุญ!")
    print("โ ุฌููุน ุงูููููุงุช ุชุนูู ุจุดูู ุตุญูุญ")
    print("โ ุงููุธุงู ุฌุงูุฒ ููุฅูุชุงุฌ")
    print("=" * 60)
    
    return True

if __name__ == "__main__":
    success = comprehensive_notification_scenario()
    sys.exit(0 if success else 1)